---
- name: Copy API client config to hosts
  hosts: all
  gather_facts: no

  pre_tasks:
    - name: Load CSV data from spotify_creds.csv
      # Reads the CSV file and converts it into a list of dictionaries.
      set_fact:
        csv_data: "{{ lookup('file', 'spotify_creds.csv') | from_csv(header=True) }}"
      delegate_to: localhost
      run_once: true

  tasks:
    - name: Set host-specific credentials from CSV
      # This sets host-specific facts by indexing into csv_data using the host's position
      set_fact:
        client_id: "{{ csv_data[ host_index ].client_id }}"
        client_secret: "{{ csv_data[ host_index ].client_secret }}"
      vars:
        host_index: "{{ ansible_play_batch.index(inventory_hostname) }}"

    - name: Copy the api-client-config.yml file to the host
      template:
        src: templates/api-client-config.yml.j2
        dest: ~/async-scraper-api/api-server/api-client-config.yml
      become: yes